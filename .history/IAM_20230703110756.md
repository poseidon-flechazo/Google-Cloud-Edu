# IAM
2023/07/03

## 役割と権限
- 役割は権限の集合
`rules/cloudmigration.inframanager`という**役割**には`compute.instances.create`という**権限**が含まれる
- 特定のアカウントに役割を付与
例：自分のプロジェクトに対する`compute admin`の役割を自分のアカウントに付与する
```bash
gcloud projects add-iam-policy-binding ca-qulijing-edu \
    --member=user:qu.lijing@cloud-ace.jp \
    --role=roles/compute.admin
```
結果：
```
Updated IAM policy for project [ca-qulijing-edu].
bindings:
- members:
  - user:qu.lijing@cloud-ace.jp
  role: roles/compute.admin
- members:
  - serviceAccount:service-458262848244@compute-system.iam.gserviceaccount.com
  role: roles/compute.serviceAgent
- members:
  - serviceAccount:458262848244-compute@developer.gserviceaccount.com
  - serviceAccount:458262848244@cloudservices.gserviceaccount.com
  - serviceAccount:celery@ca-qulijing-edu.iam.gserviceaccount.com
  role: roles/editor
- members:
  - user:qu.lijing@cloud-ace.jp
  role: roles/owner
etag: BwX_iz8XhN0=
version: 1
```


## サービスアカウント
- Google Cloudのリソースを参照するなんらかの環境で実行されるアプリケーションは、人間のアカウントではなく、サービスアカウントを利用して認証することになる
### 作成
```bash
gcloud iam service-accounts create celery --display-name=CELERY --project=ca-qulijing-edu
```
### 一覧
```bash
gcloud iam service-accounts list --project=ca-qulijing-edu
```
結果：
```
DISPLAY NAME                            EMAIL                                               DISABLED
CELERY                                  celery@ca-qulijing-edu.iam.gserviceaccount.com      False
TEAMB                                   teamb1@ca-qulijing-edu.iam.gserviceaccount.com      False
Compute Engine default service account  458262848244-compute@developer.gserviceaccount.com  False
```
### 作成したアサービスカウントをVMインスタンスから利用する
- サービスアカウントを指定するVMインスタンスを作成
```bash
gcloud compute instances create use-sa \
  --machine-type=e2-micro \
  --zone=asia-northeast1-b \
  --network=wifi408 \
  --subnet=tokyo \
  --tags=allow-ssh \
  --service-account=celery@ca-qulijing-edu.iam.gserviceaccount.com \
  --scopes=cloud-platform
```
結果：
```
Created [https://www.googleapis.com/compute/v1/projects/ca-qulijing-edu/zones/asia-northeast1-b/instances/use-sa].
NAME    ZONE               MACHINE_TYPE  PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP    STATUS
use-sa  asia-northeast1-b  e2-micro                   10.0.0.17    35.221.77.194  RUNNING
```
- SSH接続して確認
```bash
qu.lijing@use-sa:~$ gcloud auth list
```
結果：
```
                Credentialed Accounts
ACTIVE  ACCOUNT
*       celery@ca-qulijing-edu.iam.gserviceaccount.com

To set the active account, run:
    $ gcloud config set account `ACCOUNT`
```
- サービスアカウントに`compute viewer`の役割を付与する
作成したサービスアカウントには何も権利がなくて、最低限閲覧の権限を与えよう
```bash
gcloud projects add-iam-policy-binding ca-qulijing-edu \
    --member=serviceAccount:celery@ca-qulijing-edu.iam.gserviceaccount.com \
    --role=roles/compute.viewer
```
結果：
```
Updated IAM policy for project [ca-qulijing-edu].
bindings:
- members:
  - user:qu.lijing@cloud-ace.jp
  role: roles/compute.admin
- members:
  - serviceAccount:service-458262848244@compute-system.iam.gserviceaccount.com
  role: roles/compute.serviceAgent
- members:
  - serviceAccount:celery@ca-qulijing-edu.iam.gserviceaccount.com
  role: roles/compute.viewer
- members:
  - serviceAccount:458262848244-compute@developer.gserviceaccount.com
  - serviceAccount:458262848244@cloudservices.gserviceaccount.com
  - serviceAccount:celery@ca-qulijing-edu.iam.gserviceaccount.com
  role: roles/editor
- members:
  - user:qu.lijing@cloud-ace.jp
  role: roles/owner
etag: BwX_i4EDjHQ=
version: 1
```
- サービスアカウントの権限を確認
再度SSHアクセスして、サービスアカウントに入って、インスタンスを閲覧かどうかを確認
```bash
qu.lijing@use-sa:~$ gcloud compute instances list
```
結果：
```
NAME    ZONE               MACHINE_TYPE  PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP    STATUS
use-sa  asia-northeast1-b  e2-micro                   10.0.0.17    35.221.77.194  RUNNING
```
問題なく閲覧できた


## サービスアカウントの権限借用
- `roles/iam.serviceAccountTokenCreator`の役割を自身のアカウントに付与する
```bash
gcloud iam service-accounts add-iam-policy-binding celery@ca-qulijing-edu.iam.gserviceaccount.com \
  --member=user:qu.lijing@cloud-ace.jp \
  --role=roles/iam.serviceAccountTokenCreator \
  --project=ca-qulijing-edu
```
結果：
```
Updated IAM policy for serviceAccount [celery@ca-qulijing-edu.iam.gserviceaccount.com].
bindings:
- members:
  - user:qu.lijing@cloud-ace.jp
  role: roles/backupdr.computeEngineOperator
- members:
  - user:qu.lijing@cloud-ace.jp
  role: roles/iam.serviceAccountTokenCreator
etag: BwX_i5wwySI=
version: 1
```
- `impersonate-service-account`オブションをさーびすあ付与する