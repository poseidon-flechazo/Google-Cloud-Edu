# IAM
2023/07/03

## 役割と権限
- 役割は権限の集合
`rules/cloudmigration.inframanager`という**役割**には`compute.instances.create`という**権限**が含まれる
- 特定のアカウントに役割を付与
例：自分のプロジェクトに対する`compute admin`の役割を自分のアカウントに付与する
```bash
gcloud projects add-iam-policy-binding ca-qulijing-edu \
    --member=user:qu.lijing@cloud-ace.jp \
    --role=roles/compute.admin
```
結果：
```
Updated IAM policy for project [ca-qulijing-edu].
bindings:
- members:
  - user:qu.lijing@cloud-ace.jp
  role: roles/compute.admin
- members:
  - serviceAccount:service-458262848244@compute-system.iam.gserviceaccount.com
  role: roles/compute.serviceAgent
- members:
  - serviceAccount:458262848244-compute@developer.gserviceaccount.com
  - serviceAccount:458262848244@cloudservices.gserviceaccount.com
  - serviceAccount:celery@ca-qulijing-edu.iam.gserviceaccount.com
  role: roles/editor
- members:
  - user:qu.lijing@cloud-ace.jp
  role: roles/owner
etag: BwX_iz8XhN0=
version: 1
```

## サービスアカウント
- Google Cloudのリソースを参照するなんらかの環境で実行されるアプリケーションは、人間のアカウントではなく、サービスアカウントを利用して認証することになる
### 作成
```bash
gcloud iam service-accounts create celery --display-name=CELERY --project=ca-qulijing-edu
```
### 一覧
```bash
gcloud iam service-accounts list --project=ca-qulijing-edu
```
結果：
```
DISPLAY NAME                            EMAIL                                               DISABLED
CELERY                                  celery@ca-qulijing-edu.iam.gserviceaccount.com      False
TEAMB                                   teamb1@ca-qulijing-edu.iam.gserviceaccount.com      False
Compute Engine default service account  458262848244-compute@developer.gserviceaccount.com  False
```
### 作成したアサービスカウントをVMインスタンスから利用する
- サービスアカウントを指定するVMインスタンスを作成
```bash
gcloud compute instances create use-sa \
  --machine-type=e2-micro \
  --zone=asia-northeast1-b \
  --network=wifi408 \
  --subnet=tokyo \
  --tags=allow-ssh \
  --service-account=celery@ca-qulijing-edu.iam.gserviceaccount.com \
  --scopes=cloud-platform
```
結果：
```
```
## サービスアカウントの権限借用
- `roles/iam.serviceAccountTokenCreator`の役割を自身のアカウントに付与する
```bash
gcloud iam service-accounts add-iam-policy-binding crystal@ca-education-2023.iam.gserviceaccount.com \
  --member=user:tominaga.yuki@cloud-ace.jp \
  --role=roles/iam.serviceAccountTokenCreator \
  --project=ca-education-2023
```